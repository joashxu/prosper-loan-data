---
title: "Prosper Loan Data Exploration"
author: "Joash Xu"
date: "July 27, 2015"
output: html_document
---

## Overview

```{r echo=FALSE, message=FALSE, warning=FALSE, packages}
library(ggplot2)
library(gridExtra)
library(dplyr)
library(tidyr)
library(MASS)
library(scales)
library(GGally)

require(grid)
```

Let's load the Prosper data and take a look at the number row and column.

```{r echo=FALSE, Load_the_Data}
# Load the Data
prosper <- read.csv('~/Study/prosper-loan-data/dataset/prosperLoanData.csv')
```

Row count:
``` {r echo=FALSE}
nrow(prosper)
```

Column count:
``` {r echo=FALSE}
ncol(prosper)
```

There are 113937 listing in the dataset with 81 variables.
For the scope of this project, I am going to limit the number of variable.
The question is which variables. 

Looking at how prosper works[1], I add variables that fits the following criteria:

1. Basic information, information that a user gives to the site (loan amount, loan category, etc.) when they want to register for a loan.
2. Credit profile, information that may aid in generating the 'Prosper rating', 'Borrower rate' and 'Term'. This can be seen in the loan listing page on Prosper site.
3. Other information, 'Prosper Rating', 'Borrower rate', 'Term', 'ListingCreationDate'


```{r echo=FALSE}
# Payment history
df <- prosper[, c("DelinquenciesLast7Years", "PublicRecordsLast10Years")]
            
# Debt burden
df <- cbind(df, prosper[, c("DebtToIncomeRatio", "BankcardUtilization",
                            "RevolvingCreditBalance")])

# Length of credit history 
today <- Sys.Date()
df$DaysWithCreditLine <- as.numeric(
  floor(
    difftime(today,
             as.Date(prosper$FirstRecordedCreditLine,
                     "%Y-%m-%d %H:%M:%S")
            )
    )
  )

# Recent searches
df$InquiriesLast6Months <- prosper$InquiriesLast6Months 

# Amount, employment status and listing category 
df$LoanOriginalAmount <- prosper$LoanOriginalAmount
df$ListingCategory <- factor(prosper$ListingCategory..numeric.,
                             labels=c("Not available", "Debt consolidation",
                                      "Home improvement", "Business",
                                      "Personal loan", "Student use",
                                      "Auto", "Other", "Baby & Adoption Loans",
                                      "Boat", "Cosmetic Procedures", 
                                      "Engagement Ring Financing",
                                      "Green Loans", "Household Expenses",
                                      "Large Purchases", "Medical/Dental",
                                      "Motorcycle", "RV", "Taxes",
                                      "Vacation", "Wedding Loans"))
df$EmploymentStatus <- prosper$EmploymentStatus
df$AnnualIncome <- prosper$StatedMonthlyIncome * 12

# Rate, Terms, Score and Listing creation date
df$BorrowerRate <- prosper$BorrowerRate
df$Term <- factor(prosper$Term)
df$ProsperRating <- factor(prosper$ProsperRating..Alpha., levels = c("AA", "A", "B", "C", "D", "E", "HR"))
df$ListingCreationDate <- prosper$ListingCreationDate

# Verify the structure
str(df)
```

Let's take a look at the data summary:

``` {r echo=FALSE}
summary(df)
```

---

# Univariate Plots Section

## Basic information

### Loan amount
```{r echo=FALSE, Loan_amount}
lim <- quantile(df$LoanOriginalAmount, 0.99, na.rm = TRUE);

ggplot(aes(x = LoanOriginalAmount), data = df) +
  geom_histogram(binwidth=1000) +
  scale_x_continuous(
    limits = c(0, lim),
    breaks = seq(0, lim, 1000)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Several sharp line on the amount, no surprise here, people tend to borrow in whole numbers. 
Let's take a look at the statistic a bit.

```{r echo=FALSE}
summary(df$LoanOriginalAmount)
```

The minimum loan is 1000, with the median of 6500 and mean of 8337.

Let's see the most common loan amount.

```{r echo=FALSE}
Mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}

Mode(df$LoanOriginalAmount)
```

Interesting to note that 4000 is the most common amount people borrowed, followed by 10000 and 15000.

The maximum loan requested is 35000. Let's see how many listing asked for that much.

```{r echo=FALSE}
nrow(subset(df, LoanOriginalAmount == 35000))
```

Not many, only 430 out all of the observation.

### Loan category
```{r echo=FALSE, Loan_category}
ggplot(aes(x = ListingCategory), data = df) +
  geom_bar() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

summary(df$ListingCategory)
```

Most people borrow to consolidate their debts, in total there are 58308 case or about 
51.17%.

### Employment Status
```{r echo=FALSE, Employment_status}
ggplot(aes(x = EmploymentStatus), data = df) +
  geom_bar() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

summary(df$EmploymentStatus)
```

Most borrowers are employed. There are 67322 employed borrowers or about 59%.

### Annual Income
```{r echo=FALSE, Annual_income}
lim <- quantile(df$AnnualIncome, 0.99, na.rm = TRUE);
ggplot(aes(x = AnnualIncome), data = df) +
  geom_histogram(binwidth = 1000) +
    scale_x_continuous(
      limits = c(0, lim),
      breaks = seq(0, lim, 10000)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

At binwidth=1000, we can see sharp line around some amount, which make sense, since user tend to input a whole number. The histogram is skewed to the left. 

Another look at larger binwidth.

```{r echo=FALSE, Annual_income_larger_binwidth}
ggplot(aes(x = AnnualIncome), data = df) +
  geom_histogram(binwidth=5000) +
    scale_x_continuous(
    limits = c(0, lim),
    breaks = seq(0, lim, 10000)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r echo=FALSE}
summary(df$AnnualIncome)
```

The median for AnnualIncome is 56000, the mean is 67300.
The maximum entry is 21 million (1750000 per month).

## Credit profile

### Payment history

```{r echo=FALSE, Payment_History}
lim <- quantile(df$DelinquenciesLast7Years, 0.99, na.rm = TRUE);
plot1 <- ggplot(aes(x = DelinquenciesLast7Years), data = df) +
  geom_histogram(binwidth = 1) +
  scale_x_continuous(
    limits = c(0, lim),
    breaks = seq(0, lim, 1)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

lim <- quantile(df$PublicRecordsLast10Years, 0.99, na.rm = TRUE);
plot2 <- ggplot(aes(x = PublicRecordsLast10Years), data = df) +
  geom_histogram(binwidth = 1) +
  scale_x_continuous(
    limits = c(0, lim),
    breaks = seq(0, lim, 1)) 

grid.arrange(plot1, plot2, nrow = 2)
```

Most borrower have no deliquencies in the last 7 years or public records in the last 10 years.
If I remove the borrower with 0 deliquencies and 0 public records. I got:

```{r echo=FALSE, Payment_History2}
lim <- quantile(df$DelinquenciesLast7Years, 0.99, na.rm = TRUE);
plot1 <- ggplot(aes(x = DelinquenciesLast7Years), data = df) +
  geom_histogram(binwidth=1) +
  scale_x_continuous(
    limits = c(1, lim),
    breaks = seq(1, lim, 1)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

lim <- quantile(df$PublicRecordsLast10Years, 0.99, na.rm = TRUE);
plot2 <- ggplot(aes(x = PublicRecordsLast10Years), data = df) +
  geom_histogram(binwidth = 1) +
  scale_x_continuous(
    limits = c(1, lim),
    breaks = seq(1, lim, 1)) 

grid.arrange(plot1, plot2, nrow = 2)
```

Let's take a look at the statistics for DelinquenciesLast7Years.

``` {r echo = FALSE}
summary(df$DelinquenciesLast7Years)
table(df$DelinquenciesLast7Years)
```

While most borrowers has 0 deliquencies, there are still 3967 borrowers who have at least 1 deliquencies in the last 7 years. And there are also 110 borrowers that have 99 (maximum ) Deliquencies in the last 7 years.

And the statistics for PublicRecordsLast10Years.

``` {r echo = FALSE}
summary(df$PublicRecordsLast10Years)
table(df$PublicRecordsLast10Years)
```

While most borrowers has 0 public records for the last 10 years,
there are 22834 borrowers have at least 1 public records in the last 10 years.
The maximum public records is 38.

### Debt burden

**Debt to Income Ratio**

A debt income ratio is the percentage of a consumer's monthly gross income that goes toward paying debts. The data is capped at 10.01, debt-to-income ratio larger then 1000% will be returned as 1001%.

Removing the upper quantile on the data we got:

```{r echo=FALSE, Debt_Burden}
lim <- quantile(df$DebtToIncomeRatio, 0.99, na.rm = TRUE);
ggplot(aes(x = DebtToIncomeRatio), data = df) +
  geom_histogram(binwidth = 0.05) +
  scale_x_continuous(
    limits = c(0, lim),
    breaks = seq(0, lim, 0.05)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

summary(df$DebtToIncomeRatio)
```

The maximum is 10.01. This is specified in the data definition, debt to income ratio is always capped to 10.01 (1001%). The minimum value is 0. With the median of 0.22 and mean of 0.276.  


**Revolving Credit Balance**

Revolving Credit Balance is the total outstanding balance that the borrower owes on open credit cards or other revolving credit accounts.

```{r echo=FALSE}
lim <- quantile(df$RevolvingCreditBalance, 0.99, na.rm = TRUE);
ggplot(aes(x = RevolvingCreditBalance), data = df) +
  geom_histogram(binwidth = 5000) +
  scale_x_continuous(
    limits = c(0, lim),
    breaks = seq(0, lim, 5000)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

summary(df$RevolvingCreditBalance)
```

The median is 8549 and mean 17600. The maximum value is 1436000.
The minimum and the most common amount is 0.

**Bankcard Utilization**

Bankcard utilization is the sum of the balances owed on open bankcards divided by the sum of the card's credit limits. Lower usually means better.

```{r echo=FALSE}
lim <- quantile(df$BankcardUtilization, 0.99, na.rm = TRUE);
ggplot(aes(x = BankcardUtilization), data = df) +
  geom_histogram(binwidth = 0.05) +
  scale_x_continuous(
    limits = c(0, 2),
    breaks = seq(0, 2, 0.05)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

summary(df$BankcardUtilization)
```

There are interestingly 2 peaks in the plot, first there are a lot of borrowers who have almost 0% Bankcard Utilization and then another peak near 100%.
There are some borrowers who have utilization > 1.00 (100%).

Number of borrowers with BankcardUtilization < 0.05:
``` {r echo=FALSE}
nrow(subset(df, BankcardUtilization < 0.05))
```

Number of borrowers near 1:
``` {r echo=FALSE}
nrow(subset(df, BankcardUtilization >= 0.95 & BankcardUtilization < 1))
```

Number of borrowers with BankcardUtilization >= 1:
``` {r echo=FALSE}
nrow(subset(df, BankcardUtilization >= 1))
```
There are 2574 borrowers who has bankcard utilization > 1.
That means they owed more then the credit limit.


### Length of credit history

Length of credit history is the number of days from the date when the oldest account on the borrower's credit record was opened till today.

```{r echo=FALSE, Credit_History}
plot1 <- qplot(x = DaysWithCreditLine, data = df, binwidth = 30)
# See it in terms of years
plot2 <- qplot(x = DaysWithCreditLine / 365, data = df, binwidth = 1, label="Years with credit line")

grid.arrange(plot1, plot2)

summary(df$DaysWithCreditLine)
```

There is a credit line going up to 60 years.

## Other information

```{r echo=FALSE}
qplot(x = ProsperRating, data = df)

summary(df$ProsperRating)
```

The most common rating (excluding the NA's) is rating C, 18345.
Only 5372 listing have AA rating or about 4.71%.

```{r echo=FALSE}
qplot(x = Term, data = df)

summary(df$Term)
```

Most loans have 36 months term or about 77%.

```{r echo=FALSE}
qplot(x = BorrowerRate * 100, data = df, binwidth = 1)

summary(df$BorrowerRate)
```

The median for the borrower rate is 18.4% and mean 19.28%.
The maximum borrower rate is 0.4975 or 49.75%.
There are 6 observation that has more then 40% borrower rate.

# Univariate Analysis

*What is/are the main feature(s) of interest in your dataset?*

The main features of the data are:

- DelinquenciesLast7Years 
- PublicRecordsLast10Years
- DebtToIncomeRatio       
- BankcardUtilization     
- RevolvingCreditBalance  
- DaysWithCreditLine      
- InquiriesLast6Months    
- LoanOriginalAmount      
- ListingCategory         
- EmploymentStatus        
- AnnualIncome            
- BorrowerRate            
- Term                    
- ProsperRating 

I chose this variables, because these variable is visible from the UI[1].

*What other features in the dataset do you think will help support your investigation into* your feature(s) of interest?

I added ListingCreationDate. I added it just to see if there is "trend" in the behavior.

*Did you create any new variables from existing variables in the dataset?*

Yes, Days with credit line.

*Of the features you investigated, were there any unusual distributions? Did you perform any operations on the data to tidy, adjust, or change the form of the data? If so, why did you do this?*

All of the money related variables (LoanOriginalAmoun, RevolvingCreditBalance and AnnualIncome) are positively skewed. I do not transform the data for univariate analysis.

---

# Bivariate Plots Section

Let's see the relationship between LoanOriginalAmount with ListingCategory.

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(aes(x = ListingCategory, y = LoanOriginalAmount), data = df) +
  geom_boxplot() +
  scale_y_continuous(limits = c(0, quantile(df$LoanOriginalAmount, 0.99, na.rm = TRUE))) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

The baby and adoption loans looks similar to debt consolodation. Let's take a look at the statistics.

```{r echo=FALSE, message=FALSE, warning=FALSE}
summary(subset(df, ListingCategory == 'Debt consolidation')$LoanOriginalAmount)
summary(subset(df, ListingCategory == 'Baby & Adoption Loans')$LoanOriginalAmount)
```

The top one is debt consolidation summary and the bottom one is baby and adoption loans.
Very close but not similar.

Interesting to note that wedding loans is quite high. Let's take a look at the numbers.

```{r echo=FALSE, message=FALSE, warning=FALSE}
summary(subset(df, ListingCategory == 'Wedding Loans')$LoanOriginalAmount)
```

The median and mean are 7500 and 8836, with maximum value up to 35000. 

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Employment status and loan amount
ggplot(aes(x = EmploymentStatus, y = LoanOriginalAmount), data = df) +
  geom_boxplot() +
  scale_y_continuous(limits = c(0, quantile(df$LoanOriginalAmount, 0.99, na.rm = TRUE))) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
summary(subset(df, EmploymentStatus == 'Not employed')$LoanOriginalAmount)
summary(subset(df, EmploymentStatus == 'Part-time')$LoanOriginalAmount)
```

Interesting to see that not employed is requesting loan higher then part time.
The median and the mean of not employed borrower are 4000 and 4873 vs 3000 and 4089 from part time borrower. Both max loans are 25000.

Now let's look at the relationship between LoanOriginalAmount with AnnualIncome.

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(aes(x = LoanOriginalAmount, y = AnnualIncome), data = df) +
  geom_point(alpha = 0.05) + 
  stat_quantile() +
  scale_y_continuous(
    limits = c(0, quantile(df$AnnualIncome, 0.99, na.rm = TRUE)))
```

Most of the Loan are below 10000 and annual income is under 100000.
The quantile shows that the higher the annual income the higher the median of the loan original amount.

The number of the data that have original amount < 10000 and annual income less then 100000 is:
```{r echo=FALSE, message=FALSE, warning=FALSE}
nrow(subset(df, LoanOriginalAmount < 10000 & AnnualIncome < 100000))
```
which is around 57.53% of the data.

It seems that people who borrow > 25000 has annual income of >= 100000
looks like there some kind of rule, that if you borrow > 25000 the the minimal
annual income is 100000.

Let's verify this a bit.

```{r echo=FALSE, message=FALSE, warning=FALSE}
summary(subset(df, LoanOriginalAmount > 25000)$AnnualIncome)
```

And yes the minimum annual income is 100000.
Let's also check the correlation between the 2 variables.

```{r echo=FALSE, message=FALSE, warning=FALSE}
cor(df$AnnualIncome, df$LoanOriginalAmount)
```

This indicate weak positive relationship. 

Now let's check the DebtToIncomeRatio with BorrowerRate.

``` {r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(aes(x = DebtToIncomeRatio, y = BorrowerRate), data = df) +
  geom_point(alpha = 0.05, position = "jitter") +
  scale_x_continuous(limits = c(0, quantile(df$DebtToIncomeRatio, 0.99, na.rm = TRUE))) +
  scale_y_continuous(limits = c(0, quantile(df$BorrowerRate, 0.99, na.rm = TRUE)))
```

That is not too informative. Let's add some quantile information.

``` {r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(aes(x = DebtToIncomeRatio, y = BorrowerRate), data = df) +
  geom_point(alpha = 0.05, position = "jitter") +
  stat_quantile() +
  scale_x_continuous(limits = c(0, quantile(df$DebtToIncomeRatio, 0.99, na.rm = TRUE))) +
  scale_y_continuous(limits = c(0, quantile(df$BorrowerRate, 0.99, na.rm = TRUE)))
```

The median of the borrower rate gets higher as the debt to income ratio gets higher as well.

Another way to look at this is by breaking the DebtToIncomeRatio into several bins.

``` {r echo=FALSE, message=FALSE, warning=FALSE}
df$DebtToIncomeRatio.bin <- with(df, cut(as.numeric(DebtToIncomeRatio), 
                                         c(0, 0.1, 0.2, 0.3, 0.4, 0.5, 
                                           0.6, 0.7, 0.8, 0.9, 1,
                                           10)))
df$DebtToIncomeRatio.bin <- factor(df$DebtToIncomeRatio.bin,
                             labels=c("0-10%",  "10-20%", "20-30%", "30-40%",
                                      "40-50%", "50-60%", "60-70%", "70-80%",
                                      "80-90%", "90-100%", "100-1000%"))
```

A quick look at the newly created variable.

``` {r echo=FALSE, message=FALSE, warning=FALSE}
qplot(x = DebtToIncomeRatio.bin, data = na.omit(df))
```

Let's have another look at the relationship between DebtToIncomeRatio with BorrowerRate.

``` {r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(aes(x = DebtToIncomeRatio.bin, y = BorrowerRate * 100), data = df) +
  geom_boxplot() +
  ylab("Borrower Rate Percentage") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

We can see that the BorrowerRate median increases the higher the DebtToIncomeRatio.
Let's check the correlation between these 2 variables.

``` {r echo=FALSE, message=FALSE, warning=FALSE}
cor(df$DebtToIncomeRatio, df$BorrowerRate, use = 'complete.obs')
```

The correlation is not all that significant, it show no or neglible relationship.
This is contrary to my initial assumption. I assume the correlation will be positive.

Seperating the debt to income ratio provide an interesting look into the data, let's separate the borrower rate into bin as well.

``` {r echo=FALSE, message=FALSE, warning=FALSE}
df$BorrowerRate.bin <- with(df, cut(as.numeric(BorrowerRate), 
                                         c(0, 0.1, 0.2, 0.3, 0.4, 0.5, 10)))
df$BorrowerRate.bin <- factor(df$BorrowerRate.bin,
                             labels=c("0-10%",  "10-20%", "20-30%", "30-40%",
                                      "40-50%"))
```

Quick look at the result.

``` {r echo=FALSE, message=FALSE, warning=FALSE}
qplot(x = BorrowerRate.bin, data = na.omit(df))
```

Let's check the relationship with annual income.

``` {r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(aes(x = BorrowerRate.bin, y = AnnualIncome), data = df) +
  geom_boxplot() +
  scale_y_continuous(
    limits = c(0, quantile(df$AnnualIncome, 0.99, na.rm = TRUE)))

ggplot(aes(x = BorrowerRate, y = AnnualIncome), data = df) +
  geom_point(alpha = 0.05, position = "jitter") +
  stat_quantile() +
  scale_y_continuous(
    limits = c(0, quantile(df$AnnualIncome, 0.99, na.rm = TRUE)))
```

These two plots are the same, the first one using the newly created BorrowerRate bins.
Generally these plots shows the more you annual income the less is your borrower rate.

Let's take a look at the correlation.

``` {r echo=FALSE, message=FALSE, warning=FALSE}
cor(df$AnnualIncome, df$BorrowerRate, use = 'complete.obs')
```

Again while the plot show some trend, the correlation between the two variables is negligible.

Let's see the relationship of the borrower rate with other variables.

``` {r echo=FALSE, message=FALSE, warning=FALSE}
plot1 <- ggplot(aes(x = BankcardUtilization, y = BorrowerRate), data = df) +
  geom_point(alpha = 0.005) +
  stat_smooth(method = "lm")

plot2 <- ggplot(aes(x = RevolvingCreditBalance, y = BorrowerRate), data = df) +
  geom_point(alpha = 0.005) +
  stat_smooth(method = "lm")

plot3 <- ggplot(aes(x = DelinquenciesLast7Years, y = BorrowerRate), data = df) +
  geom_point(alpha = 0.005) +
  stat_smooth(method = "lm") 

plot4 <- ggplot(aes(x = PublicRecordsLast10Years, y = BorrowerRate), data = df) +
  geom_point(alpha = 0.005) +
  stat_smooth(method = "lm")

plot5 <- ggplot(aes(x = DaysWithCreditLine, y = BorrowerRate), data = df) +
  geom_point(alpha = 0.005) +
  stat_smooth(method = "lm")

plot6 <- ggplot(aes(x = InquiriesLast6Months, y = BorrowerRate), data = df) +
  geom_point(alpha = 0.005) +
  stat_smooth(method = "lm")

grid.arrange(plot1, plot2, plot3, plot4, plot5, plot6, nrow = 3, ncol = 2)
```

As BankcardUtilization, DeliquenciesLast7Years and PublicRecordsLast10Years increases so is the borrower rate. On the other hand the lower the RevolvingCreditBalance the lower the BorrowerRate.

Let's check the correlation.

Correlation between BorrowerRate with BankcardUtilization:
``` {r echo=FALSE, message=FALSE, warning=FALSE}
cor(df$BorrowerRate, df$BankcardUtilization, use = "complete.obs")
```
Correlation between BorrowerRate with RevolvingCreditBalance:
``` {r echo=FALSE, message=FALSE, warning=FALSE}
cor(df$BorrowerRate, df$RevolvingCreditBalance, use = "complete.obs")
```
Correlation between BorrowerRate with DelinquenciesLast7Years:
``` {r echo=FALSE, message=FALSE, warning=FALSE}
cor(df$BorrowerRate, df$DelinquenciesLast7Years, use = "complete.obs")
```
Correlation between BorrowerRate with PublicRecordsLast10Years:
``` {r echo=FALSE, message=FALSE, warning=FALSE}
cor(df$BorrowerRate, df$PublicRecordsLast10Years, use = "complete.obs")
```
Correlation between BorrowerRate with DaysWithCreditLine:
``` {r echo=FALSE, message=FALSE, warning=FALSE}
cor(df$BorrowerRate, df$DaysWithCreditLine, use = "complete.obs")
```
Correlation between BorrowerRate with InquiriesLast6Months:
``` {r echo=FALSE, message=FALSE, warning=FALSE}
cor(df$BorrowerRate, df$InquiriesLast6Months, use = "complete.obs")
```

BankcardUtilization has a weak positive relationship. The other factor, while showing position relationship for DelinquenciesLast7Years, PublicRecordsLast10Years and negative relationship for RevolvingCreditBalance, has a negligible relationship.
 
Let's take a look at the relation of Term with other variables now.

``` {r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(aes(y = LoanOriginalAmount, x = Term), data = df) +
  geom_boxplot() +
  scale_y_continuous(
    limits = c(0, quantile(df$LoanOriginalAmount, 0.99, na.rm = TRUE)))
```

The median for the LoanOriginalAmount increases as the terms get longer.
Let's verify this.

``` {r echo=FALSE, message=FALSE, warning=FALSE}
summary(subset(df, Term == 12)$LoanOriginalAmount)
summary(subset(df, Term == 36)$LoanOriginalAmount)
summary(subset(df, Term == 60)$LoanOriginalAmount)
```

And entry with term 60 has median of 11500,  5000 for 36 and 3500 for 12.

``` {r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(aes(x = Term, y = AnnualIncome), data = df) +
  geom_boxplot() +
  scale_y_continuous(
    limits = c(0, quantile(df$AnnualIncome, 0.99, na.rm = TRUE)))

summary(subset(df, Term == 12)$AnnualIncome)
summary(subset(df, Term == 36)$AnnualIncome)
summary(subset(df, Term == 60)$AnnualIncome)
```

The median for 12 months term is 67000 higher then the 36 months term which is 54000.

The relationship with DebtToIncomeRatio

``` {r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(aes(y = DebtToIncomeRatio, x = Term), data = df) +
  geom_boxplot() +
  scale_y_continuous(
    limits = c(0, quantile(df$DebtToIncomeRatio, 0.99, na.rm = TRUE)))

summary(subset(df, Term == 12)$DebtToIncomeRatio)
summary(subset(df, Term == 36)$DebtToIncomeRatio)
summary(subset(df, Term == 60)$DebtToIncomeRatio)
```

The median of the DebtToIncomeRatio increases as the terms goes up.
For 60 months term the median is 0.23, for 36 months term the median is 0.21.

Another look, this time using DebtToIncomeRatio.bin.

``` {r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(aes(x = DebtToIncomeRatio.bin, fill = Term), data = df) +
  geom_bar(position = "fill") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

The term distribution actually is pretty even across the DebtToIncomeRatio.bin.
Let's check the correlation.
``` {r echo=FALSE, message=FALSE, warning=FALSE}
cor(as.numeric(df$Term), df$DebtToIncomeRatio, use = "complete.obs")
```

We see that correlation number is neglible.

Let's look at borrower rate vs term as well.

``` {r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(aes(x = BorrowerRate.bin, fill = Term), data = df) +
  geom_bar(position = "fill") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

This is quite interesting borrower rate above 30% does not have 12 months Term.

``` {r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(aes(x = Term, y = BorrowerRate), data = df) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Okay we see the same result from the boxplot.
Let's look at the number.

``` {r echo=FALSE, message=FALSE, warning=FALSE}
summary(subset(df, Term == 12)$BorrowerRate)
summary(subset(df, Term == 36)$BorrowerRate)
summary(subset(df, Term == 60)$BorrowerRate)
```

The median BorrowerRate for 60 months term is 0.1870, the highest among the 3.

Let's check ProsperRating relationship with DebtToIncomeRatio and BorrowerRate now.

``` {r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(aes(x = ProsperRating, y = BorrowerRate), data = df) + 
  geom_boxplot()
```

The better rating the lower the borrower rate. 
Let's verify this.

``` {r echo=FALSE, message=FALSE, warning=FALSE}
RatingSummary <- function(rating) {
  return(summary(subset(df, ProsperRating == rating)$BorrowerRate))
}

RatingSummary('AA')
RatingSummary('A')
RatingSummary('B')
RatingSummary('C')
RatingSummary('D')
RatingSummary('E')
RatingSummary('HR')
```

The borrower rate median get increases as we move to worse rating.

Okay let's now check out the Debt to income ratio.

``` {r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(aes(x = ProsperRating, y = ..count..), data = na.omit(df)) +
  geom_bar(aes(fill = DebtToIncomeRatio.bin), position = "fill")
```

It seems at rating AA, the maximum DebToIncomeRatio is 50%.
Let's inspect the data for this.

``` {r echo=FALSE, message=FALSE, warning=FALSE}
summary(subset(df, ProsperRating == 'AA')$DebtToIncomeRatio.bin)
```

Our initial thought is not true. Even for AA rating we still have debt to income ratio > 50%. So there are listing where the prosper rating is good but the debt to income ratio is more then 50%. 

# Bivariate Analysis

*Talk about some of the relationships you observed in this part of the investigation. How did the feature(s) of interest vary with other features in the dataset?*

I wanted to see how several features affect the borrower rate, term and prosper rating.
I put several data into "bins" as this makes it a bit easier to work with.
By using this on borrower rate, debt to income ratio and delinquicies observations, we can
paint a clearer picture on the relationship between features.

We can see for instance the borrower rate increases as debt to income ratio increases.
The term seems to be related with loan original amount, the bigger the amount the longer the term. The borrower rate also shows a slight increase as the delinquincies in last 7 years goes up.


*Did you observe any interesting relationships between the other features (not the main feature(s) of interest)?*

No.

*What was the strongest relationship you found?*

If we plot the ProsperRating against other features, the plot became much clearer.
For instance we can quickly see that the debt to income ratio for rating AA will be lower then other rating.

The borrower rate shows an even clearer picture. The better your rating the lower your borrower rate. At rating C, the number of listing that have borrower rate between 0 to 10% is only 8. 

Term is not affected by the rating, the most common terms is 36 across the ratings.

The debt to income ratio distribution in each rating is also interesting to see.
While there is a pattern that shows that the higher the debt to income ratio tend to be more significant in lower rating (HR), there seems to be exception. For instance people with 
huge debt to income ratio can also have a prosper rating AA, not much 4 out of 5150 almost zero percent.


---

# Multivariate Plots Section

Let's compare the debt to income ratio again, this time faceted by rating.

```{r echo=FALSE, message=FALSE, warning=FALSE, Multivariate_Plots}
ggplot(aes(x = DebtToIncomeRatio, y = BorrowerRate), data = na.omit(df)) +
  geom_point(alpha = 0.1, position = "jitter") +
  stat_quantile(quantiles = c(0.5)) + 
  facet_grid(~ProsperRating) +
  scale_x_continuous(limits = c(0, 1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

From the bivariate analysis, the correlation between DebtToIncomeRatio is not actually that strong. This plot shows that. Most of the DebtToIncomeRatio is clustered under 1. But really the strong relationship is between the rating and borrower rate.
In fact, on rating B, D and E, the median for borrower rate decrease as the debt to income ratio raises.

Let's take a look at the distribution instead.

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(aes(x = BorrowerRate.bin, y = ..count..), data = na.omit(df)) +
  geom_bar(aes(fill = DebtToIncomeRatio.bin), position = "fill") +
  facet_grid(~ProsperRating) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

If we look at the plot above, we see that on rating AA, there is no borrower rate bin larger then 20%. So it does shows the distribution of borrower rate pretty good (better rating, better borrower rate). But if we look at the debt to income ratio bins, we see that they are all over the place. It is true that rating HR you got more borrower with high debt to income ratio, but we also have low debt to income ratio as well.

Next, let's see if we can add another dimension by using ListingCreationDate.

```{r echo=FALSE, message=FALSE, warning=FALSE}
data <- separate(df, ListingCreationDate, c("Year", "Month", "Date"))
data <- subset(data, ProsperRating != "")
ggplot(aes(x = Year, fill = BorrowerRate.bin), data = na.omit(data)) +
  geom_bar(position = "fill") +
  facet_grid(~ProsperRating) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

There is some different from year to year feature distribution within rating.
For instance the the borrower rate distribution we can see that the borrower rate for rating AA in 2013 and 2014 almost all between 0-10%. For rating B we seems to have borrower rate of 20-30% in 2011 and 2012, but 10-20% in 2013 and 2014.

Let's do the same with debt to income ratio.

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(aes(x = Year, fill = DebtToIncomeRatio.bin), data = na.omit(data)) +
  geom_histogram(position = "fill") +
  facet_grid(~ProsperRating) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

The distribution shows interesting patterns. The debt to income ratio for each rating,
seem to have allow higher debt to income ratio from year to year.



------

# Final Plots and Summary

### Plot One
```{r echo=FALSE, message=FALSE, warning=FALSE, Plot_One}
grouped.df <- na.omit(df) %>% 
  mutate_each_(funs(scale),
               vars=c("DebtToIncomeRatio","BankcardUtilization",
                      "RevolvingCreditBalance", "DaysWithCreditLine",
                      "DelinquenciesLast7Years",
                      "PublicRecordsLast10Years",
                      "InquiriesLast6Months")) %>%
  group_by(ProsperRating) %>%
  summarize(AverageDTI = mean(DebtToIncomeRatio, na.rm = TRUE),
            AverageBCU = mean(BankcardUtilization, na.rm = TRUE),
            AverageRCB = mean(RevolvingCreditBalance, na.rm = TRUE),
            AverageDelinquencies = mean(DelinquenciesLast7Years, na.rm = TRUE),
            AveragePublicRecords = mean(PublicRecordsLast10Years, na.rm = TRUE),
            AverageCreditLine = mean(DaysWithCreditLine, na.rm = TRUE),
            AverageInquiries = mean(InquiriesLast6Months, na.rm = TRUE))

cols <- c("DebtToIncomeRatio" = "#e41a1c",
          "BankcardUtilization" = "#377eb8",
          "RevolvingCreditBalance" = "#4daf4a",
          "DelinquenciesLast7Years" = "#984ea3",
          "PublicRecordsLast10Years" = "#ff7f00",
          "DaysWithCreditLine" = "#ffff33",
          "InquiriesLast6Months"= "#a65628")

ggplot(aes(x = ProsperRating),data = grouped.df) +
  geom_line(aes(y = AverageDTI,  group = 1, colour = "DebtToIncomeRatio")) +
  geom_point(aes(y = AverageDTI, colour = "DebtToIncomeRatio")) +
  geom_line(aes(y = AverageBCU,  group = 1, colour = "BankcardUtilization")) +
  geom_point(aes(y = AverageBCU, colour = "BankcardUtilization")) +  
  geom_line(aes(y = AverageRCB,  group = 1, colour = "RevolvingCreditBalance")) +
  geom_point(aes(y = AverageRCB, colour = "RevolvingCreditBalance")) +
  geom_line(aes(y = AverageDelinquencies,  group = 1, colour = "DelinquenciesLast7Years")) +
  geom_point(aes(y = AverageDelinquencies, colour = "DelinquenciesLast7Years")) +  
  geom_line(aes(y = AveragePublicRecords,  group = 1, colour = "PublicRecordsLast10Years")) +
  geom_point(aes(y = AveragePublicRecords, colour = "PublicRecordsLast10Years")) +  
  geom_line(aes(y = AverageCreditLine,  group = 1, colour = "DaysWithCreditLine")) +
  geom_point(aes(y = AverageCreditLine, colour = "DaysWithCreditLine")) +  
  geom_line(aes(y = AverageInquiries,  group = 1, colour = "InquiriesLast6Months")) +
  geom_point(aes(y = AverageInquiries, colour = "InquiriesLast6Months")) +  
  scale_colour_manual(name = "Factor",values = cols) +
  ylab("Average of scaled data") +
  ggtitle("Effect of several factor on ProsperRating")
```

### Description One

This plot shows the effect of several factor on ProsperRating.
The data for each factor is scaled, grouped by prosper rating and averaged.
I use line plot to show how each factor trend for each ProsperRating.
Since it is scaled, the point also show how far it is from the mean (the 0 line).

Several things we can see:

* If a borrower have less bankcard utilization usually, he/she will get a better rating.
* This is also the case for debt to income ratio, deliquencies last 7 years, inquiries last 6 months and public record last 10 years.
* On the other hand the longer you have credit line (DaysWithCreditLine) the better.
* The more you have revolving credit balance the better your rating.
* For HR rating the most important factor it seems are inquiries for the last 6 months and debt to income ratio, which makes sense, if a borrower is shopping around for credit that does not look good. Other factor seems not to be as important, for instance if we take bankcard utilization it is actually less then rating E or even D. This happens to other factor as well. Days with credit line for HR also shows this behavior it is actually better then R and D and even C.

### Plot Two
```{r echo=FALSE, message=FALSE, warning=FALSE, Plot_Two}
ggplot(aes(x = factor("BorrowerRate.bin"), fill = BorrowerRate.bin), data = data) +
  geom_histogram(position = "fill") +
  facet_grid(~ProsperRating) +
  scale_y_continuous(labels = percent) +
  ylab("% of listing") +
  xlab("Borrower rate") +
  ggtitle("Prosper distribution of BorrowerRate, Facet by Prosper Rating") +
  scale_fill_discrete(name = "Borrower Rate") +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
```

### Description Two

This plot shows the borrower rate distribution for borrower based on ProsperRating.
If your rating is AA you will likely get 0-10% borrower rate, if your rating is A, B, or C, you will likely get 10-20%, for D and E it is between 20-30% and 30-40% for HR.
Note while most of rating HR has high borrowing rate (30-40%), the are still a few who have
10-20% borrower rate. 

### Plot Three
```{r echo=FALSE,  message=FALSE, warning=FALSE, Plot_Three}
data <- separate(df, ListingCreationDate, c("Year", "Month", "Date"))
data <- subset(data, ProsperRating != "")
ggplot(aes(x = Year, fill = BorrowerRate.bin), data = data) +
  geom_histogram(position = "fill") +
  facet_grid(~ProsperRating) +
  scale_y_continuous(labels = percent) +
  ylab("% of listing") +
  xlab("Year of Creation") +
  ggtitle("Prosper Listing Creation by Year\n
           Distribution by BorrowerRate, Facet by Prosper Rating") +
  scale_fill_discrete(name = "Borrower Rate") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### Description Three

This plot is another look at plot 2 with added dimension of listing creation date.
The plot shows the trend of borrower rate from 2009 and 2014 faceted by ProsperRating.
We can see that if a borrower is rated AA in 2009 they can get 10-20% borrower rate.
In 2013 and 2014, if you are rated AA you will  get 0-10% borrower rate.
If you are rated E in 2009 most borrower will get 30-40% rate,
but in 2014 you can actually get 20-30% borrower rate.  The number of borrower with 20-30% borrower rate also increases significantly for rating E in 2012 onwards.
For HR in 2009 and 2010, quite a number of borrower can still have a 10-20% borrower rate.
but 2011 onward this no longer possible.

Overall, it seems in 2009, the borrower rate is actually quite high. Even for rating AA a borrower can still get 20-30% borrower rate. If you are rating is E in 2009 you will likely to get 30-40% borrower rate. This no longer happen in 2014, In 2014, AA will most likey give you 0-10% borrower rate. A, B,  and C rating will get 10-20%, D and E most likely 20-30%.
In 2014 for  HR rating you can still get 20-30% borrower rating, in contrast in 2011-2012 this will not be possible.

------

# Reflection

The Prosper data has a lot of variables, for this scope of the project I limited the number of variables to investigate. The first part is to select which variables to investigate.
After much thought, I use the variable that a borrower can actually see in the loan listing page[1]. I do this because I assume these are the metric that is important for lender to look at before actually lending money, so it is a good start.

Initially I wanted to show the relationship between the variables with borrower rate, for instance debt to income ratio vs borrower rate, bankcard utilization vs borrower rate.
To ease the exploration I have put several variables into "bins". Putting it into bins makes it easier for me to show the relationships between variables.

It is also much easier to show relationship based on ProsperRating then borrower rate. For instance if we faceted debt to income ratio with ProsperRating, it is easier to see that the lower your debt to income ratio the better is your rating. And then show the better you rating the better is you borrower rate.

Even on this limited number of variables, there is a lot of thing that we can investigate further. One thing we can try to take a look as how to a borrower gets the ProsperRating.
What are the make up of ProsperRating. I layout several factor but, those factors are based on Prosper UI[1]. In the data there are also information on borrower credit score. So it is interesting to see what kind of relationship exists between credit score and ProsperRating.

# References

[1] https://www.prosper.com/help/topics/how-to-read-a-loan-listing/
